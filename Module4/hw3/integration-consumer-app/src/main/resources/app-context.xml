<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:camel="http://camel.apache.org/schema/spring"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
                        http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
                        http://www.springframework.org/schema/context
                        http://www.springframework.org/schema/context/spring-context-4.1.xsd
                        http://camel.apache.org/schema/spring 
                        http://camel.apache.org/schema/spring/camel-spring.xsd">

    <context:property-placeholder location="classpath:app.properties" />
    
    <context:annotation-config />

    <bean id="connectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
        <property name="brokerURL" value="${app.activemq.broker.url}" />
    </bean>

    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="connectionFactory" ref="connectionFactory" />
    </bean>

    <camel:camelContext id="camelContext">

        <camel:endpoint id="commandsQueue" uri="activemq:queue:{{queue.name}}">
            <camel:property key="" value=""/>
        </camel:endpoint>
        
        <camel:dataFormats>
            <camel:json id="jacksonJsonMarshaller" library="Jackson" unmarshalTypeName="com.epam.cdp.hnyp.architecture.integration.producer.ArifmeticCommand" />
        </camel:dataFormats>

        <camel:onException>
            <camel:exception>java.lang.RuntimeException</camel:exception>
            <camel:transform>
                <camel:simple>Error occured : ${exception.message}</camel:simple>
            </camel:transform>
            <camel:to uri="stream:out" />
            <camel:to uri="activemq:queue:{{queue.error}}" />            
        </camel:onException>

        <camel:route>
            <camel:from uri="timer://generateTimer?period={{app.messages.generateInterval}}" />
            
            <!-- after timer fires start reading from queue -->
            <camel:from ref="commandsQueue" />
            
            <camel:unmarshal ref="jacksonJsonMarshaller" />

            <!-- calculator supports different operator mapping -->
            <camel:bean ref="arifmeticCommandBodyTransformer" method="transform" />
            
            <camel:to uri="bean:arifmeticCommandExecutor?method=executeCommand" />

            <camel:log message="succesfuly processed" loggingLevel="INFO" />
            
        </camel:route> 
        
    </camel:camelContext>
    
    <bean id="arifmeticCommandBodyTransformer" class="com.epam.cdp.hnyp.architecture.integration.consumer.ArifmeticCommandBodyTransformer">
        <property name="operatorMapping">
            <map>
                <entry key="add" value="+" />
                <entry key="sub" value="-" />
                <entry key="div" value="/" />
                <entry key="mul" value="*" />
            </map>
        </property>
    </bean>
    
    <bean id="calculatorFactory" class="com.epam.cdp.hnyp.calculator.factory.impl.SimpleCalculatorFactory" />
    <bean id="calculator" class="com.epam.cdp.hnyp.calculator.Calculator" 
        factory-bean="calculatorFactory" factory-method="createCalculator" />
        
    <bean id="arifmeticCommandExecutor" class="com.epam.cdp.hnyp.architecture.integration.consumer.ArifmeticCommandExecutor" />

</beans>
